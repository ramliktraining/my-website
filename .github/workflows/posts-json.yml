name: Generate posts.json
  run: |
    node <<'EOF'
    const fs = require('fs');
    const matter = require('gray-matter');

    if (!fs.existsSync('posts')) {
      console.log("No posts directory yet, creating empty posts.json");
      fs.writeFileSync('posts.json', '[]');
      process.exit(0);
    }

    const files = fs.readdirSync('posts').filter(f => f.endsWith('.md'));
    const posts = files.map(f => {
      const raw = fs.readFileSync(`posts/${f}`, 'utf8');
      const { data } = matter(raw);
      return {
        title: data.title || f,
        date: data.date ? String(data.date) : '',
        slug: data.slug || f.replace(/\.md$/, ''),
        cover: data.cover || '',
        description: data.description || data.excerpt || ''
      };
    }).sort((a, b) => {
      const dateA = String(a.date || "");
      const dateB = String(b.date || "");
      return dateB.localeCompare(dateA);
    });

    fs.writeFileSync('posts.json', JSON.stringify(posts, null, 2));
    console.log("Generated posts.json with", posts.length, "entries");
    EOF
